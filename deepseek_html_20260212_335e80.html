<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iFinance 14 Â· dark Â· Kategorien & Schulden</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- js-cookie -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Apple Dark Â· iPhone 14 optimiert Â· Schmale Stats */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, 'Helvetica Neue', 'SF Pro Display', 'SF Pro Text', sans-serif;
        }

        body {
            background-color: #000;
            background: radial-gradient(circle at 50% 0%, #1c1c1e, #0b0b0c);
            color: #f5f5f7;
            padding: 18px 12px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* iPhone 14 Glasmorphismus */
        .glass-panel {
            background: rgba(28, 28, 32, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            padding: 20px 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            width: 100%;
            max-width: 440px;
            margin-bottom: 16px;
        }

        h1, h2, h3 {
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        h1 {
            font-size: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* SCHMALE STATS â€“ 3 in einer Reihe, aber kompakt fÃ¼r iPhone 14 */
        .stats-row {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            margin: 16px 0 4px;
        }

        .stat-badge {
            background: rgba(44, 44, 48, 0.7);
            border-radius: 18px;
            padding: 10px 8px;
            flex: 1;
            text-align: center;
            backdrop-filter: blur(4px);
            border: 0.2px solid rgba(255,255,255,0.1);
            min-width: 0; /* verhindert Ãœberlauf */
        }

        .stat-label {
            font-size: 12px;
            color: #98989e;
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            line-height: 1.2;
            color: white;
        }

        .green { color: #34c759; }
        .red { color: #ff3b30; }
        .orange { color: #ff9f0a; }

        .btn {
            border: none;
            border-radius: 40px;
            padding: 12px 16px;
            font-size: 16px;
            font-weight: 500;
            background: rgba(120,120,128,0.24);
            color: white;
            backdrop-filter: blur(10px);
            border: 0.3px solid rgba(255,255,255,0.1);
            transition: 0.15s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-green {
            background: #34c759;
            color: black;
            font-weight: 600;
        }
        .btn-red {
            background: #ff3b30;
            color: white;
        }
        .btn-orange {
            background: #ff9f0a;
            color: black;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-field, select {
            background: rgba(20,20,24,0.9);
            border: 0.5px solid rgba(255,255,255,0.2);
            border-radius: 14px;
            padding: 12px 16px;
            color: white;
            font-size: 16px;
            width: 100%;
            backdrop-filter: blur(10px);
            appearance: none;
        }

        .input-field::placeholder {
            color: #8e8e93;
        }

        /* Kategorien Chips */
        .category-chip {
            background: rgba(60, 60, 70, 0.6);
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            border: 0.5px solid rgba(255,255,255,0.1);
            margin: 0 4px 6px 0;
        }
        .category-chip i {
            margin-right: 6px;
        }
        .active-category {
            background: #007aff;
            color: white;
            border-color: #0a84ff;
        }

        .debt-item {
            background: rgba(44,44,48,0.7);
            border-radius: 18px;
            padding: 16px;
            margin: 10px 0;
            border-left: 6px solid #ff9f0a;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .debt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .debt-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .small-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 30px;
            padding: 8px 16px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(5px);
        }

        .reminder-badge {
            background: #ff9f0a30;
            color: #ff9f0a;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 13px;
        }

        canvas {
            width: 100% !important;
            height: auto !important;
            max-height: 180px;
            background: rgba(10,10,12,0.4);
            border-radius: 18px;
            padding: 8px;
        }

        .divider {
            height: 0.5px;
            background: rgba(255,255,255,0.15);
            margin: 20px 0;
        }

        /* Schuldenerinnerung â€“ rot badge */
        .reminder-active {
            background: #ff3b3020;
            border: 0.5px solid #ff3b30;
        }
    </style>
</head>
<body>

    <!-- HEADER mit schmalen Stats (angepasst fÃ¼r iPhone 14) -->
    <div class="glass-panel" style="padding-bottom: 12px;">
        <h1>
            <i class="fas fa-chart-pie" style="color: #34c759;"></i> iFinance 14
            <span style="font-size: 14px; background: #1c1c1e; padding: 5px 12px; border-radius: 40px; color: #34c759; margin-left: auto;">â‚¬ EUR</span>
        </h1>
        <div class="stats-row">
            <div class="stat-badge">
                <div class="stat-label"><i class="fas fa-wallet"></i> Balance</div>
                <div class="stat-number" id="balanceDisplay">â‚¬0.00</div>
            </div>
            <div class="stat-badge">
                <div class="stat-label"><i class="fas fa-calendar-alt"></i> Monat</div>
                <div class="stat-number" id="monthChange">+â‚¬0.00</div>
            </div>
            <div class="stat-badge">
                <div class="stat-label"><i class="fas fa-clock"></i> Woche</div>
                <div class="stat-number" id="weekChange">+â‚¬0.00</div>
            </div>
        </div>
    </div>

    <!-- CHART mit Zeitraumauswahl -->
    <div class="glass-panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3><i class="fas fa-chart-bar"></i> Verlauf</h3>
            <span class="badge" id="chartRangeLabel" style="background: #34c75920; padding: 5px 14px; border-radius: 40px;">7 Tage</span>
        </div>
        <canvas id="balanceChart"></canvas>
        <div class="flex-row" style="justify-content: space-evenly; margin-top: 10px;">
            <button id="rangeWeekBtn" style="background: #34c75930; padding: 6px 18px; border-radius: 30px; border: none; color:white;"><i class="fas fa-calendar-week"></i> Woche</button>
            <button id="rangeMonthBtn" style="background: #ff3b3030; padding: 6px 18px; border-radius: 30px; border: none; color:white;"><i class="fas fa-calendar-alt"></i> Monat</button>
            <button id="rangeYearBtn" style="background: #ff9f0a30; padding: 6px 18px; border-radius: 30px; border: none; color:white;"><i class="fas fa-calendar"></i> Jahr</button>
        </div>
    </div>

    <!-- NEU: TRANSAKTION mit KATEGORIEN + eigener Kategorie -->
    <div class="glass-panel">
        <h3 style="margin-bottom: 14px;"><i class="fas fa-tags" style="color: #34c759;"></i> Einnahme / Ausgabe</h3>
        <div class="flex-row" style="margin-bottom: 12px;">
            <input type="number" id="amountInput" placeholder="Betrag â‚¬" class="input-field" style="flex:2;" step="0.01">
            <select id="typeSelect" class="input-field" style="flex:1.2;">
                <option value="intake">ðŸ“ˆ Einnahme</option>
                <option value="payment">ðŸ“‰ Ausgabe</option>
            </select>
        </div>
        <!-- KATEGORIEN AUSWAHL -->
        <div style="margin-bottom: 12px;">
            <span style="color:#98989e; font-size: 14px;"><i class="fas fa-list"></i> Kategorie:</span>
            <div id="categoryContainer" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                <!-- dynamisch per JS befÃ¼llt -->
            </div>
        </div>
        <!-- EIGENE KATEGORIE HINZUFÃœGEN -->
        <div class="flex-row" style="margin-top: 6px;">
            <input type="text" id="newCategoryInput" placeholder="neue Kategorie" class="input-field" style="flex:2;">
            <button id="addCategoryBtn" class="btn" style="flex:1; background: #5856d6;"><i class="fas fa-plus"></i> Hinzu</button>
        </div>
        <button id="addTransactionBtn" class="btn btn-green" style="margin-top: 16px;"><i class="fas fa-check"></i> Transaktion speichern</button>
    </div>

    <!-- SCHULDEN mit ERINNERUNG & ABBEZAHLT BUTTON -->
    <div class="glass-panel">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h3><i class="fas fa-hand-holding-usd orange"></i> Schulden & Erinnerungen</h3>
            <span id="reminderCounter" class="reminder-badge">0 Ã¼berfÃ¤llig</span>
        </div>
        <div id="debtsList" style="margin: 12px 0;">
            <!-- SchuldeneintrÃ¤ge -->
        </div>
        <div class="flex-row" style="gap: 6px;">
            <input type="text" id="debtPersonInput" placeholder="Name" class="input-field" style="flex:2;">
            <input type="number" id="debtAmountInput" placeholder="â‚¬" class="input-field" style="flex:1;" step="0.01">
        </div>
        <div style="display: flex; gap: 8px; margin-top: 14px;">
            <button id="addDebtBtn" class="btn" style="background: #ff9f0a; color:black; flex:1;"><i class="fas fa-arrow-left"></i> Ich schulde</button>
            <button id="addOwedBtn" class="btn" style="background: #34c759; color:black; flex:1;"><i class="fas fa-arrow-right"></i> Schuldet mir</button>
        </div>
        <!-- ERINNERUNG AKTIVIEREN Checkbox -->
        <label style="display: flex; align-items: center; gap: 10px; margin-top: 16px; background: rgba(255,59,48,0.1); padding: 12px; border-radius: 16px;">
            <input type="checkbox" id="reminderToggle" style="width: 22px; height: 22px; accent-color: #ff3b30;" checked>
            <span style="color: white;"><i class="fas fa-bell"></i> Erinnerung fÃ¼r offene Schulden (rote Markierung)</span>
        </label>
    </div>

    <!-- WÃ„HRUNGSKONVERTER -->
    <div class="glass-panel">
        <h3><i class="fas fa-euro-sign"></i> WÃ¤hrungsrechner</h3>
        <div class="flex-row" style="margin-bottom: 8px;">
            <input type="number" id="convAmount" placeholder="1.00" class="input-field" style="flex:2;" value="1.00">
            <select id="convFrom" class="input-field" style="flex:1;">
                <option value="EUR" selected>EUR</option>
                <option value="USD">USD</option>
            </select>
        </div>
        <div style="text-align: center;"><i class="fas fa-arrow-down" style="color:#34c759;"></i></div>
        <div class="flex-row" style="margin-top: 8px;">
            <input type="text" id="convResult" readonly class="input-field" style="flex:2;" value="1.09 USD">
            <select id="convTo" class="input-field" style="flex:1;">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
            </select>
        </div>
        <button id="convertBtn" class="btn" style="margin-top: 16px; background: #007aff;"><i class="fas fa-rotate"></i> Konvertieren</button>
    </div>

    <!-- EXPORT / IMPORT -->
    <div class="glass-panel">
        <div class="flex-row" style="gap: 12px;">
            <button id="exportDataBtn" class="btn" style="background: #5856d6; flex:1;"><i class="fas fa-download"></i> Export</button>
            <button id="importDataBtn" class="btn" style="background: #5856d6; flex:1;"><i class="fas fa-upload"></i> Import</button>
            <input type="file" id="importFileInput" accept=".json" style="display: none;">
        </div>
        <p class="small-note" style="text-align: center; margin-top: 12px; color: #787880;"><i class="fas fa-cookie-bite"></i> Cookie speichert automatisch</p>
    </div>

    <script>
        // ==================== DATEN & COOKIES ====================
        const COOKIE_KEY = "ifinance14_pro";

        let appData = {
            transactions: [],
            debts: [],
            categories: ['Wohnen', 'Lebensmittel', 'Freizeit', 'Transport', 'Gehalt'],  // Standardkategorien
            customCategories: []
        };

        // Cookie laden
        function loadFromCookie() {
            let stored = Cookies.get(COOKIE_KEY);
            if (stored) {
                try {
                    let parsed = JSON.parse(stored);
                    if (parsed.transactions) appData.transactions = parsed.transactions;
                    if (parsed.debts) appData.debts = parsed.debts;
                    if (parsed.categories) appData.categories = parsed.categories;
                    if (parsed.customCategories) appData.customCategories = parsed.customCategories || [];
                } catch (e) {}
            }
            if (!appData.categories || appData.categories.length === 0) {
                appData.categories = ['Wohnen', 'Lebensmittel', 'Freizeit', 'Transport', 'Gehalt'];
            }
            if (!appData.customCategories) appData.customCategories = [];
        }

        function saveToCookie() {
            Cookies.set(COOKIE_KEY, JSON.stringify(appData), { expires: 400, secure: true, sameSite: 'strict' });
        }

        // ========== BALANCE & STATS ==========
        function getBalance() {
            return appData.transactions.reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
        }

        function getMonthChange() {
            let now = Date.now(), monthAgo = now - 30*24*60*60*1000;
            return appData.transactions.filter(t => t.timestamp >= monthAgo).reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
        }
        function getWeekChange() {
            let now = Date.now(), weekAgo = now - 7*24*60*60*1000;
            return appData.transactions.filter(t => t.timestamp >= weekAgo).reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
        }

        // ========== KATEGORIEN RENDERN ==========
        let selectedCategory = 'Gehalt'; // default

        function renderCategories() {
            let container = document.getElementById('categoryContainer');
            let allCats = [...appData.categories, ...appData.customCategories];
            if (allCats.length === 0) allCats = ['Allgemein'];
            let html = '';
            allCats.forEach(cat => {
                let active = (cat === selectedCategory) ? 'active-category' : '';
                html += `<span class="category-chip ${active}" data-category="${cat}"><i class="fas fa-tag"></i> ${cat}</span>`;
            });
            container.innerHTML = html;
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    selectedCategory = this.dataset.category;
                    renderCategories(); // aktiv hervorheben
                });
            });
        }

        // ========== SCHULDEN RENDERN mit ERINNERUNG & ABBEZAHLT ==========
        function renderDebts() {
            let container = document.getElementById('debtsList');
            if (appData.debts.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; background: rgba(120,120,128,0.1); border-radius: 20px;"><i class="fas fa-smile"></i> Keine Schulden</div>';
                document.getElementById('reminderCounter').innerText = '0 Ã¼berfÃ¤llig';
                return;
            }

            let reminderOn = document.getElementById('reminderToggle').checked;
            let now = Date.now();
            let overdueCount = 0;

            let html = '';
            appData.debts.forEach((debt, idx) => {
                let sign = debt.type === 'owe' ? 'â†’ Ich schulde' : 'â† Schuldet mir';
                let color = debt.type === 'owe' ? '#ff3b30' : '#34c759';
                let icon = debt.type === 'owe' ? 'fa-arrow-up' : 'fa-arrow-down';
                let reminderClass = '';
                let reminderBadge = '';
                // Erinnerung: falls Ã¤lter als 14 Tage und nicht bezahlt
                let isOverdue = (reminderOn && debt.createdAt && (now - debt.createdAt > 14 * 24 * 60 * 60 * 1000) && !debt.paid);
                if (isOverdue) {
                    reminderClass = 'reminder-active';
                    reminderBadge = '<span style="background:#ff3b30; padding:3px 12px; border-radius:30px; font-size:12px; margin-left:8px;"><i class="fas fa-bell"></i> ÃœberfÃ¤llig</span>';
                    overdueCount++;
                }
                let paidBadge = debt.paid ? '<span style="background:#34c759; color:black; padding:3px 12px; border-radius:30px; font-size:12px;"><i class="fas fa-check"></i> Bezahlt</span>' : '';

                html += `<div class="debt-item ${reminderClass}" style="border-left-color: ${color};">
                            <div class="debt-header">
                                <div><i class="fas ${icon}" style="color: ${color};"></i> <strong>${debt.person}</strong> <span style="color: ${color};">${sign}</span> ${reminderBadge} ${paidBadge}</div>
                                <div style="font-weight: 700; font-size: 18px;">â‚¬${debt.amount.toFixed(2)}</div>
                            </div>
                            <div class="debt-actions">`;
                if (!debt.paid) {
                    html += `<button class="small-btn paid-btn" data-id="${debt.id}" style="background: #34c759; color:black;"><i class="fas fa-check-circle"></i> Abbezahlt</button>`;
                }
                html += `<button class="small-btn delete-debt-btn" data-id="${debt.id}" style="background: #ff3b3040;"><i class="fas fa-trash"></i> LÃ¶schen</button>
                            </div>
                        </div>`;
            });
            container.innerHTML = html;
            document.getElementById('reminderCounter').innerHTML = `${overdueCount} Ã¼berfÃ¤llig`;

            // Eventlistener fÃ¼r abbezahlt & lÃ¶schen
            document.querySelectorAll('.paid-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    let id = this.dataset.id;
                    let debt = appData.debts.find(d => d.id === id);
                    if (debt) debt.paid = true;
                    saveToCookie();
                    renderDebts();
                });
            });
            document.querySelectorAll('.delete-debt-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    let id = this.dataset.id;
                    appData.debts = appData.debts.filter(d => d.id !== id);
                    saveToCookie();
                    renderDebts();
                });
            });
        }

        // ========== CHART ==========
        let chartInstance, rangeType = 'week';
        function getChartData(range) {
            let now = Date.now(), labels = [], values = [], cum = 0, balances = [];
            if (range === 'week') {
                for (let i = 6; i >= 0; i--) {
                    let d = new Date(now - i*86400000);
                    labels.push(d.toLocaleDateString('de-DE', { weekday: 'short' }));
                    let start = new Date(d).setHours(0,0,0,0);
                    let end = new Date(d).setHours(23,59,59,999);
                    let dayTx = appData.transactions.filter(t => t.timestamp >= start && t.timestamp <= end);
                    let bal = dayTx.reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
                    cum += bal;
                    values.push(cum);
                }
            } else if (range === 'month') {
                for (let i = 4; i >= 0; i--) {
                    labels.push(`Woche ${4-i}`);
                    let start = now - i*7*86400000;
                    let end = start + 6*86400000;
                    let weekTx = appData.transactions.filter(t => t.timestamp >= start && t.timestamp <= end);
                    let bal = weekTx.reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
                    cum += bal; values.push(cum);
                }
            } else {
                for (let i = 3; i >= 0; i--) {
                    labels.push(`Q${4-i}`);
                    let start = now - i*90*86400000;
                    let end = start + 89*86400000;
                    let qTx = appData.transactions.filter(t => t.timestamp >= start && t.timestamp <= end);
                    let bal = qTx.reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
                    cum += bal; values.push(cum);
                }
            }
            return { labels, values };
        }

        function updateChart(range) {
            let { labels, values } = getChartData(range);
            let ctx = document.getElementById('balanceChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            let bgColors = values.map((v, i) => (i === 0 || v >= values[i-1]) ? '#34c759' : '#ff3b30');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Guthaben (â‚¬)', data: values, backgroundColor: bgColors, borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            document.getElementById('chartRangeLabel').innerText = range === 'week' ? '7 Tage' : range === 'month' ? '30 Tage' : 'Jahr';
        }

        // ========== UI AKTUALISIEREN ==========
        function refreshUI() {
            let bal = getBalance();
            document.getElementById('balanceDisplay').innerHTML = `â‚¬${bal.toFixed(2)}`;
            let monthDelta = getMonthChange();
            let monthEl = document.getElementById('monthChange');
            monthEl.innerHTML = (monthDelta >= 0 ? `+â‚¬${monthDelta.toFixed(2)}` : `-â‚¬${Math.abs(monthDelta).toFixed(2)}`);
            monthEl.style.color = monthDelta >= 0 ? '#34c759' : '#ff3b30';
            let weekDelta = getWeekChange();
            let weekEl = document.getElementById('weekChange');
            weekEl.innerHTML = (weekDelta >= 0 ? `+â‚¬${weekDelta.toFixed(2)}` : `-â‚¬${Math.abs(weekDelta).toFixed(2)}`);
            weekEl.style.color = weekDelta >= 0 ? '#34c759' : '#ff3b30';
            renderDebts();
            updateChart(rangeType);
        }

        // ========== INIT ==========
        loadFromCookie();
        if (appData.transactions.length === 0) {
            appData.transactions.push({ amount: 450, type: 'intake', timestamp: Date.now() - 2*86400000, category: 'Gehalt' });
            appData.transactions.push({ amount: 89, type: 'payment', timestamp: Date.now() - 3*86400000, category: 'Lebensmittel' });
            appData.transactions.push({ amount: 32, type: 'payment', timestamp: Date.now() - 5*86400000, category: 'Transport' });
            appData.transactions.push({ amount: 120, type: 'intake', timestamp: Date.now() - 7*86400000, category: 'Freizeit' });
        }
        if (appData.debts.length === 0) {
            appData.debts.push({ person: 'Lisa', amount: 55, type: 'owed', id: crypto.randomUUID(), createdAt: Date.now() - 20*86400000, paid: false });
            appData.debts.push({ person: 'Markus', amount: 30, type: 'owe', id: crypto.randomUUID(), createdAt: Date.now() - 5*86400000, paid: false });
        }
        if (!appData.customCategories) appData.customCategories = ['Bildung', 'Gesundheit'];
        saveToCookie();

        renderCategories();
        refreshUI();

        // ========== EVENT LISTENER ==========
        document.getElementById('addTransactionBtn').addEventListener('click', function() {
            let amount = parseFloat(document.getElementById('amountInput').value);
            let type = document.getElementById('typeSelect').value;
            if (!amount || amount <= 0) return;
            appData.transactions.push({
                amount, type,
                category: selectedCategory || 'Allgemein',
                timestamp: Date.now()
            });
            saveToCookie();
            refreshUI();
            document.getElementById('amountInput').value = '';
        });

        document.getElementById('addCategoryBtn').addEventListener('click', function() {
            let newCat = document.getElementById('newCategoryInput').value.trim();
            if (newCat && !appData.categories.includes(newCat) && !appData.customCategories.includes(newCat)) {
                appData.customCategories.push(newCat);
                saveToCookie();
                renderCategories();
                document.getElementById('newCategoryInput').value = '';
            }
        });

        // Schulden
        function addDebt(person, amount, type) {
            if (!person || !amount || amount <= 0) return;
            appData.debts.push({
                person, amount: parseFloat(amount), type,
                id: crypto.randomUUID(), createdAt: Date.now(), paid: false
            });
            saveToCookie();
            renderDebts();
        }
        document.getElementById('addDebtBtn').addEventListener('click', function() {
            addDebt(document.getElementById('debtPersonInput').value, document.getElementById('debtAmountInput').value, 'owe');
            document.getElementById('debtPersonInput').value = ''; document.getElementById('debtAmountInput').value = '';
        });
        document.getElementById('addOwedBtn').addEventListener('click', function() {
            addDebt(document.getElementById('debtPersonInput').value, document.getElementById('debtAmountInput').value, 'owed');
            document.getElementById('debtPersonInput').value = ''; document.getElementById('debtAmountInput').value = '';
        });

        // WÃ¤hrung
        document.getElementById('convertBtn').addEventListener('click', function() {
            let amt = parseFloat(document.getElementById('convAmount').value) || 1;
            let from = document.getElementById('convFrom').value, to = document.getElementById('convTo').value;
            let rate = 1.09;
            let result = from === 'EUR' && to === 'USD' ? amt * rate : from === 'USD' && to === 'EUR' ? amt / rate : amt;
            document.getElementById('convResult').value = `${result.toFixed(2)} ${to}`;
        });
        document.getElementById('convertBtn').click();

        // Chart Range Buttons
        document.getElementById('rangeWeekBtn').addEventListener('click', () => { rangeType='week'; updateChart('week'); });
        document.getElementById('rangeMonthBtn').addEventListener('click', () => { rangeType='month'; updateChart('month'); });
        document.getElementById('rangeYearBtn').addEventListener('click', () => { rangeType='year'; updateChart('year'); });

        // Export / Import
        document.getElementById('exportDataBtn').addEventListener('click', function() {
            let blob = new Blob([JSON.stringify(appData)], {type: 'application/json'});
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ifinance_backup.json';
            a.click();
        });
        document.getElementById('importDataBtn').addEventListener('click', function() {
            document.getElementById('importFileInput').click();
        });
        document.getElementById('importFileInput').addEventListener('change', function(e) {
            let file = e.target.files[0];
            if (!file) return;
            let reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    let imported = JSON.parse(ev.target.result);
                    if (imported.transactions) appData = imported;
                    saveToCookie();
                    refreshUI();
                    renderCategories();
                } catch(ex) { alert('Fehler'); }
            };
            reader.readAsText(file);
        });

        // Reminder Toggle aktualisiert Anzeige
        document.getElementById('reminderToggle').addEventListener('change', function() {
            renderDebts();
        });

    </script>
</body>
</html>