<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iFinance 14 ¬∑ dark ¬∑ Reset ¬∑ Prozent</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- js-cookie -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Apple Dark ¬∑ iPhone 14 optimiert */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, 'Helvetica Neue', 'SF Pro Display', 'SF Pro Text', sans-serif;
        }

        body {
            background-color: #000;
            background: radial-gradient(circle at 50% 0%, #1c1c1e, #0b0b0c);
            color: #f5f5f7;
            padding: 18px 12px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(28, 28, 32, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            padding: 20px 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            width: 100%;
            max-width: 440px;
            margin-bottom: 16px;
        }

        h1, h2, h3 {
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        h1 {
            font-size: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KOMPAKTE STATS mit Prozent */
        .stats-row {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            margin: 16px 0 4px;
        }

        .stat-badge {
            background: rgba(44, 44, 48, 0.7);
            border-radius: 18px;
            padding: 10px 6px;
            flex: 1;
            text-align: center;
            backdrop-filter: blur(4px);
            border: 0.2px solid rgba(255,255,255,0.1);
            min-width: 0;
        }

        .stat-label {
            font-size: 11px;
            color: #98989e;
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
            color: white;
        }

        .stat-percent {
            font-size: 11px;
            margin-top: 2px;
            font-weight: 500;
        }

        .green { color: #34c759; }
        .red { color: #ff3b30; }
        .orange { color: #ff9f0a; }

        .btn {
            border: none;
            border-radius: 40px;
            padding: 12px 16px;
            font-size: 16px;
            font-weight: 500;
            background: rgba(120,120,128,0.24);
            color: white;
            backdrop-filter: blur(10px);
            border: 0.3px solid rgba(255,255,255,0.1);
            transition: 0.15s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-green {
            background: #34c759;
            color: black;
            font-weight: 600;
        }
        .btn-red {
            background: #ff3b30;
            color: white;
        }
        .btn-orange {
            background: #ff9f0a;
            color: black;
        }
        .btn-gray {
            background: #5a5a66;
            color: white;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-field, select {
            background: rgba(20,20,24,0.9);
            border: 0.5px solid rgba(255,255,255,0.2);
            border-radius: 14px;
            padding: 12px 16px;
            color: white;
            font-size: 16px;
            width: 100%;
            backdrop-filter: blur(10px);
            appearance: none;
        }

        .input-field::placeholder {
            color: #8e8e93;
        }

        /* Kategorien Chips */
        .category-chip {
            background: rgba(60, 60, 70, 0.6);
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            border: 0.5px solid rgba(255,255,255,0.1);
            margin: 0 4px 6px 0;
        }
        .category-chip i {
            margin-right: 6px;
        }
        .active-category {
            background: #007aff;
            color: white;
            border-color: #0a84ff;
        }

        .debt-item {
            background: rgba(44,44,48,0.7);
            border-radius: 18px;
            padding: 16px;
            margin: 10px 0;
            border-left: 6px solid #ff9f0a;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .debt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .debt-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .small-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 30px;
            padding: 8px 16px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(5px);
        }

        .reminder-badge {
            background: #ff9f0a30;
            color: #ff9f0a;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 13px;
        }

        canvas {
            width: 100% !important;
            height: auto !important;
            max-height: 180px;
            background: rgba(10,10,12,0.4);
            border-radius: 18px;
            padding: 8px;
        }

        .divider {
            height: 0.5px;
            background: rgba(255,255,255,0.15);
            margin: 20px 0;
        }

        .reminder-active {
            background: #ff3b3020;
            border: 0.5px solid #ff3b30;
        }

        .percent-badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 30px;
            background: rgba(255,255,255,0.05);
            margin-left: 4px;
        }
    </style>
</head>
<body>

    <!-- HEADER mit Prozent-Statistiken -->
    <div class="glass-panel" style="padding-bottom: 12px;">
        <h1>
            <i class="fas fa-chart-pie" style="color: #34c759;"></i> iFinance 14
            <span style="font-size: 14px; background: #1c1c1e; padding: 5px 12px; border-radius: 40px; color: #34c759; margin-left: auto;">‚Ç¨ EUR</span>
        </h1>
        <div class="stats-row">
            <div class="stat-badge">
                <div class="stat-label"><i class="fas fa-wallet"></i> Balance</div>
                <div class="stat-number" id="balanceDisplay">‚Ç¨0.00</div>
                <div class="stat-percent" id="balancePercent">‚Äì</div>
            </div>
            <div class="stat-badge">
                <div class="stat-label"><i class="fas fa-calendar-alt"></i> Monat</div>
                <div class="stat-number" id="monthChange">+‚Ç¨0.00</div>
                <div class="stat-percent" id="monthPercent">‚Äì</div>
            </div>
            <div class="stat-badge">
                <div class="stat-label"><i class="fas fa-clock"></i> Woche</div>
                <div class="stat-number" id="weekChange">+‚Ç¨0.00</div>
                <div class="stat-percent" id="weekPercent">‚Äì</div>
            </div>
        </div>
    </div>

    <!-- CHART -->
    <div class="glass-panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3><i class="fas fa-chart-bar"></i> Verlauf</h3>
            <span class="badge" id="chartRangeLabel" style="background: #34c75920; padding: 5px 14px; border-radius: 40px;">7 Tage</span>
        </div>
        <canvas id="balanceChart"></canvas>
        <div class="flex-row" style="justify-content: space-evenly; margin-top: 10px;">
            <button id="rangeWeekBtn" style="background: #34c75930; padding: 6px 18px; border-radius: 30px; border: none; color:white;"><i class="fas fa-calendar-week"></i> Woche</button>
            <button id="rangeMonthBtn" style="background: #ff3b3030; padding: 6px 18px; border-radius: 30px; border: none; color:white;"><i class="fas fa-calendar-alt"></i> Monat</button>
            <button id="rangeYearBtn" style="background: #ff9f0a30; padding: 6px 18px; border-radius: 30px; border: none; color:white;"><i class="fas fa-calendar"></i> Jahr</button>
        </div>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 12px;">
            <span class="small-note" style="color:#34c759;"><i class="fas fa-arrow-up"></i> Verbesserung</span>
            <span class="small-note" style="color:#ff3b30;"><i class="fas fa-arrow-down"></i> Verschlechterung</span>
        </div>
    </div>

    <!-- RESET BUTTON - GANZ OBEN SICHTBAR -->
    <div class="glass-panel" style="background: rgba(255,59,48,0.15); border: 0.5px solid #ff3b3040;">
        <div class="flex-row" style="justify-content: center;">
            <button id="hardResetBtn" class="btn btn-red" style="flex:2;"><i class="fas fa-exclamation-triangle"></i> ALLE DATEN ZUR√úCKSETZEN</button>
            <button id="softResetBtn" class="btn btn-gray" style="flex:1;"><i class="fas fa-broom"></i> Nur Konto</button>
        </div>
        <p class="small-note" style="text-align: center; margin-top: 8px; color: #ff8a80;"><i class="fas fa-cookie-bite"></i> Reset l√∂scht alles aus Cookies</p>
    </div>

    <!-- TRANSAKTION mit KATEGORIEN -->
    <div class="glass-panel">
        <h3 style="margin-bottom: 14px;"><i class="fas fa-tags" style="color: #34c759;"></i> Einnahme / Ausgabe</h3>
        <div class="flex-row" style="margin-bottom: 12px;">
            <input type="number" id="amountInput" placeholder="Betrag ‚Ç¨" class="input-field" style="flex:2;" step="0.01">
            <select id="typeSelect" class="input-field" style="flex:1.2;">
                <option value="intake">üìà Einnahme</option>
                <option value="payment">üìâ Ausgabe</option>
            </select>
        </div>
        <div style="margin-bottom: 12px;">
            <span style="color:#98989e; font-size: 14px;"><i class="fas fa-list"></i> Kategorie:</span>
            <div id="categoryContainer" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;"></div>
        </div>
        <div class="flex-row" style="margin-top: 6px;">
            <input type="text" id="newCategoryInput" placeholder="neue Kategorie" class="input-field" style="flex:2;">
            <button id="addCategoryBtn" class="btn" style="flex:1; background: #5856d6;"><i class="fas fa-plus"></i> Hinzu</button>
        </div>
        <button id="addTransactionBtn" class="btn btn-green" style="margin-top: 16px;"><i class="fas fa-check"></i> Transaktion speichern</button>
    </div>

    <!-- SCHULDEN mit ERINNERUNG & ABBEZAHLT -->
    <div class="glass-panel">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h3><i class="fas fa-hand-holding-usd orange"></i> Schulden & Erinnerungen</h3>
            <span id="reminderCounter" class="reminder-badge">0 √ºberf√§llig</span>
        </div>
        <div id="debtsList" style="margin: 12px 0;"></div>
        <div class="flex-row" style="gap: 6px;">
            <input type="text" id="debtPersonInput" placeholder="Name" class="input-field" style="flex:2;">
            <input type="number" id="debtAmountInput" placeholder="‚Ç¨" class="input-field" style="flex:1;" step="0.01">
        </div>
        <div style="display: flex; gap: 8px; margin-top: 14px;">
            <button id="addDebtBtn" class="btn" style="background: #ff9f0a; color:black; flex:1;"><i class="fas fa-arrow-left"></i> Ich schulde</button>
            <button id="addOwedBtn" class="btn" style="background: #34c759; color:black; flex:1;"><i class="fas fa-arrow-right"></i> Schuldet mir</button>
        </div>
        <label style="display: flex; align-items: center; gap: 10px; margin-top: 16px; background: rgba(255,59,48,0.1); padding: 12px; border-radius: 16px;">
            <input type="checkbox" id="reminderToggle" style="width: 22px; height: 22px; accent-color: #ff3b30;" checked>
            <span style="color: white;"><i class="fas fa-bell"></i> Erinnerung nach 14 Tagen</span>
        </label>
    </div>

    <!-- W√ÑHRUNGSKONVERTER -->
    <div class="glass-panel">
        <h3><i class="fas fa-euro-sign"></i> W√§hrungsrechner</h3>
        <div class="flex-row" style="margin-bottom: 8px;">
            <input type="number" id="convAmount" placeholder="1.00" class="input-field" style="flex:2;" value="1.00">
            <select id="convFrom" class="input-field" style="flex:1;">
                <option value="EUR" selected>EUR</option>
                <option value="USD">USD</option>
            </select>
        </div>
        <div style="text-align: center;"><i class="fas fa-arrow-down" style="color:#34c759;"></i></div>
        <div class="flex-row" style="margin-top: 8px;">
            <input type="text" id="convResult" readonly class="input-field" style="flex:2;" value="1.09 USD">
            <select id="convTo" class="input-field" style="flex:1;">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
            </select>
        </div>
        <button id="convertBtn" class="btn" style="margin-top: 16px; background: #007aff;"><i class="fas fa-rotate"></i> Konvertieren</button>
    </div>

    <!-- EXPORT / IMPORT -->
    <div class="glass-panel">
        <div class="flex-row" style="gap: 12px;">
            <button id="exportDataBtn" class="btn" style="background: #5856d6; flex:1;"><i class="fas fa-download"></i> Export</button>
            <button id="importDataBtn" class="btn" style="background: #5856d6; flex:1;"><i class="fas fa-upload"></i> Import</button>
            <input type="file" id="importFileInput" accept=".json" style="display: none;">
        </div>
        <p class="small-note" style="text-align: center; margin-top: 12px; color: #787880;"><i class="fas fa-cookie-bite"></i> Auto-Save im Cookie</p>
    </div>

    <script>
        // ==================== DATEN & COOKIES ====================
        const COOKIE_KEY = "ifinance14_final";

        let appData = {
            transactions: [],
            debts: [],
            categories: ['Wohnen', 'Lebensmittel', 'Freizeit', 'Transport', 'Gehalt'],
            customCategories: []
        };

        // Cookie laden
        function loadFromCookie() {
            let stored = Cookies.get(COOKIE_KEY);
            if (stored) {
                try {
                    let parsed = JSON.parse(stored);
                    appData = parsed;
                } catch (e) {}
            }
            // Struktur sicherstellen
            if (!appData.categories) appData.categories = ['Wohnen', 'Lebensmittel', 'Freizeit', 'Transport', 'Gehalt'];
            if (!appData.customCategories) appData.customCategories = [];
            if (!appData.debts) appData.debts = [];
            if (!appData.transactions) appData.transactions = [];
        }

        function saveToCookie() {
            Cookies.set(COOKIE_KEY, JSON.stringify(appData), { expires: 400, secure: true, sameSite: 'strict' });
        }

        // ========== RESET FUNKTIONEN ==========
        function hardReset() {
            appData = {
                transactions: [],
                debts: [],
                categories: ['Wohnen', 'Lebensmittel', 'Freizeit', 'Transport', 'Gehalt'],
                customCategories: []
            };
            saveToCookie();
            refreshUI();
            renderCategories();
        }

        function softReset() {
            appData.transactions = [];
            appData.debts = [];
            saveToCookie();
            refreshUI();
            renderCategories();
        }

        // ========== BALANCE & PROZENTE ==========
        function getBalance() {
            return appData.transactions.reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
        }

        // Perioden-Vergleiche f√ºr Prozent
        function getPreviousPeriodChange(period) {
            let now = Date.now();
            let currentStart, previousStart, previousEnd;
            
            if (period === 'week') {
                currentStart = now - 7 * 86400000;
                previousStart = now - 14 * 86400000;
                previousEnd = now - 7 * 86400000;
            } else if (period === 'month') {
                currentStart = now - 30 * 86400000;
                previousStart = now - 60 * 86400000;
                previousEnd = now - 30 * 86400000;
            } else if (period === 'year') {
                currentStart = now - 365 * 86400000;
                previousStart = now - 730 * 86400000;
                previousEnd = now - 365 * 86400000;
            }

            let currentChange = appData.transactions
                .filter(t => t.timestamp >= currentStart)
                .reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
            
            let previousChange = appData.transactions
                .filter(t => t.timestamp >= previousStart && t.timestamp < previousEnd)
                .reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);

            return { current: currentChange, previous: previousChange };
        }

        function getBalancePercentChange() {
            let totalBalance = getBalance();
            let oneMonthAgo = Date.now() - 30 * 86400000;
            let oldBalance = appData.transactions
                .filter(t => t.timestamp < oneMonthAgo)
                .reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
            
            if (oldBalance === 0) return 0;
            return ((totalBalance - oldBalance) / Math.abs(oldBalance)) * 100;
        }

        // ========== KATEGORIEN ==========
        let selectedCategory = 'Gehalt';

        function renderCategories() {
            let container = document.getElementById('categoryContainer');
            let allCats = [...appData.categories, ...appData.customCategories];
            if (allCats.length === 0) allCats = ['Allgemein'];
            let html = '';
            allCats.forEach(cat => {
                let active = (cat === selectedCategory) ? 'active-category' : '';
                html += `<span class="category-chip ${active}" data-category="${cat}"><i class="fas fa-tag"></i> ${cat}</span>`;
            });
            container.innerHTML = html;
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    selectedCategory = this.dataset.category;
                    renderCategories();
                });
            });
        }

        // ========== SCHULDEN ==========
        function renderDebts() {
            let container = document.getElementById('debtsList');
            if (appData.debts.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; background: rgba(120,120,128,0.1); border-radius: 20px;"><i class="fas fa-smile"></i> Keine Schulden</div>';
                document.getElementById('reminderCounter').innerText = '0 √ºberf√§llig';
                return;
            }

            let reminderOn = document.getElementById('reminderToggle').checked;
            let now = Date.now();
            let overdueCount = 0;

            let html = '';
            appData.debts.forEach((debt) => {
                let sign = debt.type === 'owe' ? '‚Üí Ich schulde' : '‚Üê Schuldet mir';
                let color = debt.type === 'owe' ? '#ff3b30' : '#34c759';
                let icon = debt.type === 'owe' ? 'fa-arrow-up' : 'fa-arrow-down';
                let isOverdue = (reminderOn && debt.createdAt && (now - debt.createdAt > 14 * 24 * 60 * 60 * 1000) && !debt.paid);
                if (isOverdue) overdueCount++;
                
                let reminderBadge = isOverdue ? '<span style="background:#ff3b30; padding:3px 12px; border-radius:30px; font-size:12px; margin-left:8px;"><i class="fas fa-bell"></i> √úberf√§llig</span>' : '';
                let paidBadge = debt.paid ? '<span style="background:#34c759; color:black; padding:3px 12px; border-radius:30px; font-size:12px;"><i class="fas fa-check"></i> Bezahlt</span>' : '';

                html += `<div class="debt-item" style="border-left-color: ${color};">
                            <div class="debt-header">
                                <div><i class="fas ${icon}" style="color: ${color};"></i> <strong>${debt.person}</strong> <span style="color: ${color};">${sign}</span> ${reminderBadge} ${paidBadge}</div>
                                <div style="font-weight: 700; font-size: 18px;">‚Ç¨${debt.amount.toFixed(2)}</div>
                            </div>
                            <div class="debt-actions">`;
                if (!debt.paid) {
                    html += `<button class="small-btn paid-btn" data-id="${debt.id}" style="background: #34c759; color:black;"><i class="fas fa-check-circle"></i> Abbezahlt</button>`;
                }
                html += `<button class="small-btn delete-debt-btn" data-id="${debt.id}" style="background: #ff3b3040;"><i class="fas fa-trash"></i> L√∂schen</button>
                            </div>
                        </div>`;
            });
            container.innerHTML = html;
            document.getElementById('reminderCounter').innerHTML = `${overdueCount} √ºberf√§llig`;

            document.querySelectorAll('.paid-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    let id = this.dataset.id;
                    let debt = appData.debts.find(d => d.id === id);
                    if (debt) debt.paid = true;
                    saveToCookie();
                    renderDebts();
                });
            });
            document.querySelectorAll('.delete-debt-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    let id = this.dataset.id;
                    appData.debts = appData.debts.filter(d => d.id !== id);
                    saveToCookie();
                    renderDebts();
                    refreshUI();
                });
            });
        }

        // ========== CHART ==========
        let chartInstance, rangeType = 'week';
        
        function getChartData(range) {
            let now = Date.now(), labels = [], values = [], cum = 0;
            if (range === 'week') {
                for (let i = 6; i >= 0; i--) {
                    let d = new Date(now - i*86400000);
                    labels.push(d.toLocaleDateString('de-DE', { weekday: 'short' }));
                    let start = new Date(d).setHours(0,0,0,0);
                    let end = new Date(d).setHours(23,59,59,999);
                    let dayTx = appData.transactions.filter(t => t.timestamp >= start && t.timestamp <= end);
                    let bal = dayTx.reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
                    cum += bal;
                    values.push(cum);
                }
            } else if (range === 'month') {
                for (let i = 4; i >= 0; i--) {
                    labels.push(`Woche ${4-i}`);
                    let start = now - i*7*86400000;
                    let end = start + 6*86400000;
                    let weekTx = appData.transactions.filter(t => t.timestamp >= start && t.timestamp <= end);
                    let bal = weekTx.reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
                    cum += bal; values.push(cum);
                }
            } else {
                for (let i = 3; i >= 0; i--) {
                    labels.push(`Q${4-i}`);
                    let start = now - i*90*86400000;
                    let end = start + 89*86400000;
                    let qTx = appData.transactions.filter(t => t.timestamp >= start && t.timestamp <= end);
                    let bal = qTx.reduce((acc, t) => t.type === 'intake' ? acc + t.amount : acc - t.amount, 0);
                    cum += bal; values.push(cum);
                }
            }
            return { labels, values };
        }

        function updateChart(range) {
            let { labels, values } = getChartData(range);
            let ctx = document.getElementById('balanceChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            let bgColors = values.map((v, i) => (i === 0 || v >= values[i-1]) ? '#34c759' : '#ff3b30');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'Guthaben (‚Ç¨)', 
                        data: values, 
                        backgroundColor: bgColors, 
                        borderRadius: 8,
                        borderSkipped: false
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { callbacks: { label: (ctx) => `‚Ç¨${ctx.raw.toFixed(2)}` } }
                    },
                    scales: {
                        y: { 
                            beginAtZero: false, 
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#a1a1a8' }
                        },
                        x: { ticks: { color: '#f0f0f4' } }
                    }
                }
            });
            document.getElementById('chartRangeLabel').innerText = range === 'week' ? '7 Tage' : range === 'month' ? '30 Tage' : 'Jahr';
        }

        // ========== UI AKTUALISIEREN mit PROZENTEN ==========
        function refreshUI() {
            // Balance
            let bal = getBalance();
            document.getElementById('balanceDisplay').innerHTML = `‚Ç¨${bal.toFixed(2)}`;
            
            // Balance Prozent (Ver√§nderung zum Vormonat)
            let balPercent = getBalancePercentChange();
            let balPercentEl = document.getElementById('balancePercent');
            balPercentEl.innerHTML = balPercent >= 0 ? `+${balPercent.toFixed(1)}%` : `${balPercent.toFixed(1)}%`;
            balPercentEl.style.color = balPercent >= 0 ? '#34c759' : '#ff3b30';
            
            // Monat Change & Prozent
            let monthDelta = getPreviousPeriodChange('month').current;
            let monthPrev = getPreviousPeriodChange('month').previous;
            let monthPercent = monthPrev === 0 ? 0 : ((monthDelta - monthPrev) / Math.abs(monthPrev)) * 100;
            
            document.getElementById('monthChange').innerHTML = (monthDelta >= 0 ? `+‚Ç¨${monthDelta.toFixed(2)}` : `-‚Ç¨${Math.abs(monthDelta).toFixed(2)}`);
            document.getElementById('monthChange').style.color = monthDelta >= 0 ? '#34c759' : '#ff3b30';
            
            let monthPercentEl = document.getElementById('monthPercent');
            monthPercentEl.innerHTML = monthPercent >= 0 ? `+${monthPercent.toFixed(1)}%` : `${monthPercent.toFixed(1)}%`;
            monthPercentEl.style.color = monthPercent >= 0 ? '#34c759' : '#ff3b30';
            
            // Woche Change & Prozent
            let weekDelta = getPreviousPeriodChange('week').current;
            let weekPrev = getPreviousPeriodChange('week').previous;
            let weekPercent = weekPrev === 0 ? 0 : ((weekDelta - weekPrev) / Math.abs(weekPrev)) * 100;
            
            document.getElementById('weekChange').innerHTML = (weekDelta >= 0 ? `+‚Ç¨${weekDelta.toFixed(2)}` : `-‚Ç¨${Math.abs(weekDelta).toFixed(2)}`);
            document.getElementById('weekChange').style.color = weekDelta >= 0 ? '#34c759' : '#ff3b30';
            
            let weekPercentEl = document.getElementById('weekPercent');
            weekPercentEl.innerHTML = weekPercent >= 0 ? `+${weekPercent.toFixed(1)}%` : `${weekPercent.toFixed(1)}%`;
            weekPercentEl.style.color = weekPercent >= 0 ? '#34c759' : '#ff3b30';
            
            renderDebts();
            updateChart(rangeType);
        }

        // ========== INIT ==========
        loadFromCookie();
        
        // Wenn keine Daten, Beispiel-Daten
        if (appData.transactions.length === 0) {
            let now = Date.now();
            appData.transactions.push({ amount: 1250, type: 'intake', timestamp: now - 2*86400000, category: 'Gehalt' });
            appData.transactions.push({ amount: 89.50, type: 'payment', timestamp: now - 3*86400000, category: 'Lebensmittel' });
            appData.transactions.push({ amount: 32.80, type: 'payment', timestamp: now - 5*86400000, category: 'Transport' });
            appData.transactions.push({ amount: 45, type: 'payment', timestamp: now - 8*86400000, category: 'Freizeit' });
            appData.transactions.push({ amount: 220, type: 'intake', timestamp: now - 12*86400000, category: 'Freelance' });
        }
        if (appData.debts.length === 0) {
            appData.debts.push({ person: 'Lisa', amount: 55, type: 'owed', id: crypto.randomUUID(), createdAt: Date.now() - 20*86400000, paid: false });
            appData.debts.push({ person: 'Markus', amount: 30, type: 'owe', id: crypto.randomUUID(), createdAt: Date.now() - 5*86400000, paid: false });
        }
        if (appData.customCategories.length === 0) {
            appData.customCategories = ['Freelance', 'Bildung'];
        }
        
        saveToCookie();
        renderCategories();
        refreshUI();

        // ========== EVENT LISTENER ==========
        
        // RESET Buttons
        document.getElementById('hardResetBtn').addEventListener('click', function() {
            if (confirm('‚ö†Ô∏è ALLE Daten unwiderruflich l√∂schen? (Transaktionen, Schulden, Kategorien)')) {
                hardReset();
            }
        });
        
        document.getElementById('softResetBtn').addEventListener('click', function() {
            if (confirm('Nur Kontobewegungen und Schulden l√∂schen? Kategorien bleiben.')) {
                softReset();
            }
        });

        // Transaktion
        document.getElementById('addTransactionBtn').addEventListener('click', function() {
            let amount = parseFloat(document.getElementById('amountInput').value);
            let type = document.getElementById('typeSelect').value;
            if (!amount || amount <= 0) {
                alert('Bitte g√ºltigen Betrag eingeben');
                return;
            }
            appData.transactions.push({
                amount, type,
                category: selectedCategory || 'Allgemein',
                timestamp: Date.now()
            });
            saveToCookie();
            refreshUI();
            document.getElementById('amountInput').value = '';
        });

        // Kategorie hinzuf√ºgen
        document.getElementById('addCategoryBtn').addEventListener('click', function() {
            let newCat = document.getElementById('newCategoryInput').value.trim();
            if (newCat) {
                if (!appData.categories.includes(newCat) && !appData.customCategories.includes(newCat)) {
                    appData.customCategories.push(newCat);
                    saveToCookie();
                    renderCategories();
                    document.getElementById('newCategoryInput').value = '';
                } else {
                    alert('Kategorie existiert bereits');
                }
            }
        });

        // Schulden
        function addDebt(person, amount, type) {
            if (!person || !amount || amount <= 0) {
                alert('Name und Betrag erforderlich');
                return;
            }
            appData.debts.push({
                person, amount: parseFloat(amount), type,
                id: crypto.randomUUID(), createdAt: Date.now(), paid: false
            });
            saveToCookie();
            renderDebts();
        }
        
        document.getElementById('addDebtBtn').addEventListener('click', function() {
            addDebt(
                document.getElementById('debtPersonInput').value,
                document.getElementById('debtAmountInput').value,
                'owe'
            );
            document.getElementById('debtPersonInput').value = '';
            document.getElementById('debtAmountInput').value = '';
        });
        
        document.getElementById('addOwedBtn').addEventListener('click', function() {
            addDebt(
                document.getElementById('debtPersonInput').value,
                document.getElementById('debtAmountInput').value,
                'owed'
            );
            document.getElementById('debtPersonInput').value = '';
            document.getElementById('debtAmountInput').value = '';
        });

        // W√§hrung
        document.getElementById('convertBtn').addEventListener('click', function() {
            let amt = parseFloat(document.getElementById('convAmount').value) || 1;
            let from = document.getElementById('convFrom').value;
            let to = document.getElementById('convTo').value;
            let rate = 1.09;
            let result = from === 'EUR' && to === 'USD' ? amt * rate : 
                        from === 'USD' && to === 'EUR' ? amt / rate : amt;
            document.getElementById('convResult').value = `${result.toFixed(2)} ${to}`;
        });
        document.getElementById('convertBtn').click();

        // Chart Range
        document.getElementById('rangeWeekBtn').addEventListener('click', () => { 
            rangeType = 'week'; 
            updateChart('week'); 
        });
        document.getElementById('rangeMonthBtn').addEventListener('click', () => { 
            rangeType = 'month'; 
            updateChart('month'); 
        });
        document.getElementById('rangeYearBtn').addEventListener('click', () => { 
            rangeType = 'year'; 
            updateChart('year'); 
        });

        // Export / Import
        document.getElementById('exportDataBtn').addEventListener('click', function() {
            let blob = new Blob([JSON.stringify(appData, null, 2)], {type: 'application/json'});
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ifinance_backup.json';
            a.click();
        });
        
        document.getElementById('importDataBtn').addEventListener('click', function() {
            document.getElementById('importFileInput').click();
        });
        
        document.getElementById('importFileInput').addEventListener('change', function(e) {
            let file = e.target.files[0];
            if (!file) return;
            let reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    let imported = JSON.parse(ev.target.result);
                    if (imported.transactions) {
                        appData = imported;
                        saveToCookie();
                        refreshUI();
                        renderCategories();
                        alert('Import erfolgreich!');
                    }
                } catch(ex) { 
                    alert('Fehler: Ung√ºltige Datei'); 
                }
            };
            reader.readAsText(file);
        });

        // Reminder Toggle
        document.getElementById('reminderToggle').addEventListener('change', function() {
            renderDebts();
        });

    </script>
</body>
</html>
